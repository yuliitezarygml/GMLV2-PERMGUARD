{% extends 'admin/base.html' %}

{% block title %}GML V2 - Traffic Monitor{% endblock %}

{% block admin_content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>Traffic Monitor</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="loadDemoData()" id="demo-btn">
                <i class="fas fa-database"></i> Load Demo Data
            </button>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Traffic Statistics -->
    <div class="admin-stats" id="traffic-stats">
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-globe"></i></div>
            <div class="stat-value" id="total-requests">-</div>
            <div class="stat-label">Total Requests</div>
        </div>
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stat-value" id="error-requests">-</div>
            <div class="stat-label">Errors</div>
        </div>
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-tachometer-alt"></i></div>
            <div class="stat-value" id="avg-duration">-</div>
            <div class="stat-label">Avg Duration (ms)</div>
        </div>
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-percentage"></i></div>
            <div class="stat-value" id="error-rate">-</div>
            <div class="stat-label">Error Rate (%)</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="admin-section">
        <h2>Filters</h2>
        <div class="filter-controls">
            <div class="filter-group">
                <label for="filter-user">User:</label>
                <input type="text" id="filter-user" placeholder="Filter by user...">
            </div>
            <div class="filter-group">
                <label for="filter-method">Method:</label>
                <select id="filter-method">
                    <option value="">All</option>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-status">Status:</label>
                <select id="filter-status">
                    <option value="">All</option>
                    <option value="200">200</option>
                    <option value="301">301</option>
                    <option value="302">302</option>
                    <option value="404">404</option>
                    <option value="500">500</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-duration">Min Duration (ms):</label>
                <input type="number" id="filter-duration" placeholder="100">
            </div>
            <button class="btn btn-secondary" onclick="applyFilters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
        </div>
    </div>

    <!-- Traffic Charts -->
    <div class="admin-section">
        <h2>Traffic Analytics</h2>
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Top Endpoints</h3>
                <div class="chart-content" id="endpoints-chart">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="chart-container">
                <h3>HTTP Methods</h3>
                <div class="chart-content" id="methods-chart">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="chart-container">
                <h3>Status Codes</h3>
                <div class="chart-content" id="status-chart">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="chart-container">
                <h3>Top Users</h3>
                <div class="chart-content" id="users-chart">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Traffic Logs -->
    <div class="admin-section">
        <h2>Recent Traffic</h2>
        <div class="table-container">
            <table class="admin-table" id="traffic-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Method</th>
                        <th>Path</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>User</th>
                        <th>IP</th>
                    </tr>
                </thead>
                <tbody id="traffic-logs">
                    <tr>
                        <td colspan="7" class="loading">Loading traffic data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .filter-controls {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(25, 25, 35, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 600;
    }

    .filter-group input, .filter-group select {
        padding: 8px 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
        font-size: 14px;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-container {
        background: rgba(25, 25, 35, 0.3);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 20px;
    }

    .chart-container h3 {
        margin: 0 0 15px 0;
        color: var(--text-primary);
        font-size: 16px;
        font-weight: 600;
    }

    .chart-content {
        min-height: 200px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .chart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .chart-item:last-child {
        border-bottom: none;
    }

    .chart-label {
        color: var(--text-primary);
        font-size: 14px;
    }

    .chart-value {
        color: var(--accent-color);
        font-weight: 600;
        font-size: 14px;
    }

    .status-200 { background-color: rgba(40, 167, 69, 0.2); }
    .status-300 { background-color: rgba(255, 193, 7, 0.2); }
    .status-400 { background-color: rgba(220, 53, 69, 0.2); }
    .status-500 { background-color: rgba(220, 53, 69, 0.3); }

    .method-get { color: #28a745; }
    .method-post { color: #007bff; }
    .method-put { color: #ffc107; }
    .method-delete { color: #dc3545; }

    .loading {
        text-align: center;
        color: var(--text-secondary);
        padding: 40px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        margin-left: 10px;
    }

    .btn:first-child {
        margin-left: 0;
    }

    .btn i {
        font-size: 12px;
    }

    .btn-primary {
        background: #0066ff;
        color: white;
    }

    .btn-primary:hover {
        background: #0052cc;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let trafficData = {};
let currentFilters = {};

// Load traffic data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTrafficData();
    setInterval(loadTrafficData, 30000); // Refresh every 30 seconds
});

async function loadTrafficData() {
    try {
        // Load stats
        const statsResponse = await fetch('/api/admin/traffic/stats');
        const stats = await statsResponse.json();

        if (!stats.error) {
            updateStats(stats);
            updateCharts(stats);
        }

        // Load logs
        loadTrafficLogs();
    } catch (error) {
        console.error('Error loading traffic data:', error);
    }
}

async function loadTrafficLogs() {
    try {
        const params = new URLSearchParams(currentFilters);
        const response = await fetch(`/api/admin/traffic/logs?${params}`);
        const logs = await response.json();

        if (!Array.isArray(logs)) {
            throw new Error('Invalid logs data');
        }

        updateTrafficTable(logs);
    } catch (error) {
        console.error('Error loading traffic logs:', error);
        document.getElementById('traffic-logs').innerHTML =
            '<tr><td colspan="7" class="error">Error loading traffic logs</td></tr>';
    }
}

function updateStats(stats) {
    if (stats.error) {
        document.getElementById('total-requests').textContent = '0';
        document.getElementById('error-requests').textContent = '0';
        document.getElementById('avg-duration').textContent = '0';
        document.getElementById('error-rate').textContent = '0.0';
        return;
    }

    document.getElementById('total-requests').textContent = stats.total_requests || 0;
    document.getElementById('error-requests').textContent = stats.error_requests || 0;
    document.getElementById('avg-duration').textContent = Math.round(stats.avg_duration_ms || 0);
    document.getElementById('error-rate').textContent = (stats.error_rate || 0).toFixed(1);
}

function updateCharts(stats) {
    if (stats.error) {
        // Show "no data" message for all charts
        document.getElementById('endpoints-chart').innerHTML = '<div class="loading">No data available</div>';
        document.getElementById('methods-chart').innerHTML = '<div class="loading">No data available</div>';
        document.getElementById('status-chart').innerHTML = '<div class="loading">No data available</div>';
        document.getElementById('users-chart').innerHTML = '<div class="loading">No data available</div>';
        return;
    }

    // Top Endpoints
    const endpointsChart = document.getElementById('endpoints-chart');
    if (stats.top_endpoints && stats.top_endpoints.length > 0) {
        endpointsChart.innerHTML = stats.top_endpoints.map(endpoint => `
            <div class="chart-item">
                <span class="chart-label">${endpoint.endpoint}</span>
                <span class="chart-value">${endpoint.count} (${endpoint.avg_duration}ms)</span>
            </div>
        `).join('');
    } else {
        endpointsChart.innerHTML = '<div class="loading">No endpoint data</div>';
    }

    // HTTP Methods
    const methodsChart = document.getElementById('methods-chart');
    if (stats.methods) {
        methodsChart.innerHTML = Object.entries(stats.methods).map(([method, count]) => `
            <div class="chart-item">
                <span class="chart-label method-${method.toLowerCase()}">${method}</span>
                <span class="chart-value">${count}</span>
            </div>
        `).join('');
    }

    // Status Codes
    const statusChart = document.getElementById('status-chart');
    if (stats.status_codes) {
        statusChart.innerHTML = Object.entries(stats.status_codes).map(([status, count]) => `
            <div class="chart-item">
                <span class="chart-label status-${status.charAt(0)}00">${status}</span>
                <span class="chart-value">${count}</span>
            </div>
        `).join('');
    }

    // Top Users
    const usersChart = document.getElementById('users-chart');
    if (stats.top_users && stats.top_users.length > 0) {
        usersChart.innerHTML = stats.top_users.map(user => `
            <div class="chart-item">
                <span class="chart-label">${user.user}</span>
                <span class="chart-value">${user.requests}</span>
            </div>
        `).join('');
    } else {
        usersChart.innerHTML = '<div class="loading">No user data</div>';
    }
}

function updateTrafficTable(logs) {
    const tbody = document.getElementById('traffic-logs');

    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="loading">No traffic data available</td></tr>';
        return;
    }

    tbody.innerHTML = logs.map(log => {
        const timestamp = new Date(log.timestamp).toLocaleString();
        const statusClass = `status-${Math.floor(log.status_code / 100)}00`;
        const methodClass = `method-${log.method.toLowerCase()}`;

        return `
            <tr>
                <td>${timestamp}</td>
                <td class="${methodClass}">${log.method}</td>
                <td>${log.path}</td>
                <td class="${statusClass}">${log.status_code}</td>
                <td>${log.duration_ms}ms</td>
                <td>${log.user}</td>
                <td>${log.ip_address}</td>
            </tr>
        `;
    }).join('');
}

function applyFilters() {
    currentFilters = {};

    const user = document.getElementById('filter-user').value.trim();
    if (user) currentFilters.user = user;

    const method = document.getElementById('filter-method').value;
    if (method) currentFilters.method = method;

    const status = document.getElementById('filter-status').value;
    if (status) currentFilters.status_code = status;

    const duration = document.getElementById('filter-duration').value;
    if (duration) currentFilters.min_duration = duration;

    loadTrafficLogs();
}

function clearFilters() {
    currentFilters = {};
    document.getElementById('filter-user').value = '';
    document.getElementById('filter-method').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-duration').value = '';
    loadTrafficLogs();
}

function refreshData() {
    loadTrafficData();
}

async function loadDemoData() {
    const demoBtn = document.getElementById('demo-btn');
    const originalText = demoBtn.innerHTML;

    try {
        demoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        demoBtn.disabled = true;

        const response = await fetch('/api/admin/traffic/demo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();

        if (result.success) {
            // Immediately refresh the data
            await loadTrafficData();

            // Show success message
            demoBtn.innerHTML = '<i class="fas fa-check"></i> Demo Data Loaded';
            demoBtn.className = 'btn btn-success';

            setTimeout(() => {
                demoBtn.innerHTML = originalText;
                demoBtn.className = 'btn btn-secondary';
                demoBtn.disabled = false;
            }, 3000);
        } else {
            throw new Error(result.error || 'Failed to load demo data');
        }
    } catch (error) {
        console.error('Error loading demo data:', error);
        demoBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
        demoBtn.className = 'btn btn-danger';

        setTimeout(() => {
            demoBtn.innerHTML = originalText;
            demoBtn.className = 'btn btn-secondary';
            demoBtn.disabled = false;
        }, 3000);
    }
}
</script>
{% endblock %}